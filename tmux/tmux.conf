# =============================================================================
# Terminal & Rendering
# =============================================================================

# Modern terminfo (fixes flicker + key issues with Ghostty)
set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"

# Faster escape â€” important for Neovim responsiveness
set -sg escape-time 10

# Let TUIs know when the terminal gains/loses focus
set -g focus-events on

# Allow programs (image.nvim, etc.) to bypass tmux via passthrough sequences
set -g allow-passthrough on

# Use OSC 52 for clipboard (works over SSH)
set -s set-clipboard on

# Extended key reporting (Shift+Enter, Ctrl+Enter, etc.)
set -g extended-keys on
set -g extended-keys-format csi-u


# =============================================================================
# Prefix Key
# =============================================================================

set -g prefix C-a
unbind C-b
bind C-a send-prefix


# =============================================================================
# General
# =============================================================================

set -g mouse on
set -g history-limit 10000

# Quick window navigation
bind b previous-window


# =============================================================================
# Pane Splits
# =============================================================================

bind | split-window -h
bind - split-window -v


# =============================================================================
# Pane Navigation (vim-tmux-navigator)
# =============================================================================
# Seamless Ctrl+hjkl between tmux panes and Vim/Neovim splits.
# See: https://github.com/christoomey/vim-tmux-navigator

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\S+\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind-key -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind-key -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind-key -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind-key -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# Copy-mode equivalents
bind-key -T copy-mode-vi C-h select-pane -L
bind-key -T copy-mode-vi C-j select-pane -D
bind-key -T copy-mode-vi C-k select-pane -U
bind-key -T copy-mode-vi C-l select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# Prefix + hjkl as a fallback
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R


# =============================================================================
# Pane Resizing
# =============================================================================

bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5


# =============================================================================
# Copy Mode (vi-style)
# =============================================================================

setw -g mode-keys vi

# Prefix + Space to enter copy mode
bind Space copy-mode

# v to begin selection, y to yank to system clipboard
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# Mouse drag also copies to clipboard
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"


# =============================================================================
# Utilities
# =============================================================================

# Floating nvim popup
bind p display-popup -E -w 80% -h 80% "nvim"

# Reload config
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Explicit Shift+Enter and Ctrl+Enter for TUIs
bind -n S-Enter send-keys "[13;2u"
bind -n C-Enter send-keys "[13;5u"


# =============================================================================
# Theme & Status Bar
# =============================================================================

set -g status-position bottom

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'egel/tmux-gruvbox'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

set -g @tmux-gruvbox 'dark'

# Prefix highlight
set -g @prefix_highlight_fg 'white'
set -g @prefix_highlight_bg 'red'
set -g @prefix_highlight_prefix_prompt ' CMD '
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=white,bg=blue,bold'

# Initialize TPM (keep at the end)
run '~/.tmux/plugins/tpm/tpm'

# Status bar overrides (must come after TPM init)
set -g status-left '#[fg=red,bold]#{prefix_highlight}#[default] '
set -g status-right ' %H:%M '
run-shell '~/.tmux/plugins/tmux-prefix-highlight/prefix_highlight.tmux'
