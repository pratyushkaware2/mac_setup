# ---- Environment & Path ----
export EDITOR=nvim
export PATH="$HOME/.local/bin:$PATH"

# ---- Initialize Completion System ----
# Required for fzf-tab and smart completions
autoload -Uz compinit
compinit

# ---- Plugins ----

# fzf shell integration
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
[[ -f /opt/homebrew/opt/fzf/shell/completion.zsh ]] && source /opt/homebrew/opt/fzf/shell/completion.zsh
[[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]] && source /opt/homebrew/opt/fzf/shell/key-bindings.zsh

# fzf-tab (must be loaded after compinit)
source "/opt/homebrew/opt/fzf-tab/share/fzf-tab/fzf-tab.zsh"

source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
source /opt/homebrew/share/zsh-vi-mode/zsh-vi-mode.zsh

# Syntax highlighting should be loaded LAST
source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# ---- Plugin Configuration ----

# zsh-autosuggestions
ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# zsh-vi-mode & Keybindings
# We use zvm_after_init to ensure bindings stick even after zsh-vi-mode initializes
function zvm_after_init() {
  # Use jk to escape to normal mode
  zvm_bindkey viins 'jk' zvm_exit_insert_mode
}

# Include dotfiles in completions and glob
setopt globdots

# fzf: use fd to include hidden files (excluding .git)
export FZF_DEFAULT_COMMAND='fd --hidden --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --exclude .git'

_fzf_compgen_path() {
  fd --hidden --exclude .git . "$1"
}

_fzf_compgen_dir() {
  fd --type d --hidden --exclude .git . "$1"
}

# fzf-tab configuration
zstyle ':completion:*:git-checkout:*' sort false
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'
zstyle ':fzf-tab:*' switch-group '<' '>'

# ---- Custom Functions ----

# nvim in tmux popup for editing the current zsh command line
function zle-tmux-popup-nvim() {
  if [[ -z "$TMUX" ]]; then
    autoload -Uz edit-command-line
    edit-command-line
    return
  fi

  local tmpfile
  tmpfile="$(mktemp -t zsh_cmdline.XXXXXX)" || return 1
  print -r -- "$BUFFER" >| "$tmpfile"
  tmux display-popup -E -w 90% -h 85% "nvim +'set ft=sh' '$tmpfile'"
  BUFFER="$(<"$tmpfile")"
  CURSOR=${#BUFFER}
  rm -f "$tmpfile"
  zle vi-insert
}
zle -N nvim zle-tmux-popup-nvim

# ---- Aliases ----
alias ls='eza --icons'
alias ll='eza -l --icons --git'
alias la='eza -la --icons --git'

# ---- Prompt & External Configs ----
eval "$(starship init zsh)"

# Load machine-specific configurations
[ -s "$HOME/.local.zshrc" ] && source "$HOME/.local.zshrc"
